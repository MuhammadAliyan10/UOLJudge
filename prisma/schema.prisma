// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum UserRole {
  ADMIN       // Full Access
  JURY        // Can Grade & View Logs
  PARTICIPANT // Restricted View
}

enum Category {
  CORE
  WEB
  ANDROID
}

enum Verdict {
  PENDING
  ACCEPTED
  REJECTED
  RUNTIME_ERROR // Code crashed
  COMPILE_ERROR // Syntax error
}

enum LogAction {
  LOGIN
  SUBMISSION
  MANUAL_GRADE_UPDATE
  BAN_USER
  CONTEST_UPDATE
}

// --- MODELS ---

model User {
  id            String   @id @default(uuid())
  username      String   @unique
  password_hash String
  role          UserRole @default(PARTICIPANT)

  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())

  // Relations
  team_profile     TeamProfile?
  submissions      Submission[]
  judged_submissions Submission[] @relation("JudgedBy")

  sent_clarifications     Clarification[] @relation("SentBy")
  answered_clarifications Clarification[] @relation("AnsweredBy")

  logs             SystemLog[] // Tracks what this user did
}

model TeamProfile {
  id           String   @id @default(uuid())
  user_id      String   @unique
  user         User     @relation(fields: [user_id], references: [id])

  display_name String   // "Team Alpha"
  members      Json     @default("[]") // ["Ali", "Sara"]
  lab_location String?  // "Lab 1, PC-05"
  category     Category

  // CACHING FOR FINAL RESULT PAGE
  // Instead of calculating on the fly every time, we update these
  // whenever a submission is graded.
  total_score   Int      @default(0)
  total_penalty Int      @default(0) // Time taken in minutes
  rank          Int?     // Final position (calculated at end)
}

model Contest {
  id         String   @id @default(uuid())
  name       String
  start_time DateTime
  end_time   DateTime

  // The Freeze Feature: Leaderboard stops updating for users after this time
  frozen_at  DateTime?

  is_active  Boolean  @default(true)
  config     Json     @default("{}") // { "penalty_per_wrong": 20 }

  problems   Problem[]
  announcements Announcement[]
}

model Problem {
  id          String   @id @default(uuid())
  order_index Int      @default(0) // 0=Problem A, 1=Problem B (Sorting)

  title       String
  description String   @db.Text
  category    Category

  points      Int      @default(100)

  // Display only limits (for User info)
  time_limit_sec   Float?  @default(2.0)
  memory_limit_mb  Int?    @default(256)

  assets_path String?

  contest_id  String
  contest     Contest  @relation(fields: [contest_id], references: [id])

  submissions    Submission[]
  clarifications Clarification[]
}

model Submission {
  id        String   @id @default(uuid())

  // File Artifacts
  file_path String
  file_hash String   // Security: SHA256
  language  String?  // 'cpp', 'js', 'apk'

  // Grading Logic
  verdict   Verdict  @default(PENDING)

  // HYBRID GRADING SYSTEM
  // 1. Auto: Calculated by time (Start - Submit Time)
  // 2. Manual: Admin overrides everything
  auto_score    Int      @default(0)
  manual_score  Int?     // If this exists, it ignores auto_score
  final_score   Int      @default(0) // The actual value used for Leaderboard

  // Tie-Breaker Logic
  penalty       Int      @default(0) // Time in minutes from contest start

  submitted_at DateTime @default(now())

  // Relations
  user_id   String
  user      User     @relation(fields: [user_id], references: [id])
  problem_id String
  problem    Problem @relation(fields: [problem_id], references: [id])

  judged_by_id String?
  judged_by    User?   @relation("JudgedBy", fields: [judged_by_id], references: [id])

  jury_comment String? @db.Text
}

model Clarification {
  id        String   @id @default(uuid())
  question  String   @db.Text
  answer    String?  @db.Text

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  problem_id String?
  problem    Problem? @relation(fields: [problem_id], references: [id])

  user_id   String
  user      User   @relation("SentBy", fields: [user_id], references: [id])
  answered_by_id String?
  answered_by    User?   @relation("AnsweredBy", fields: [answered_by_id], references: [id])
}

// NEW: Broadcast messages to all users
model Announcement {
  id         String   @id @default(uuid())
  title      String
  message    String   @db.Text
  created_at DateTime @default(now())

  contest_id String
  contest    Contest @relation(fields: [contest_id], references: [id])
}

// NEW: Security Logs (The "Black Box")
model SystemLog {
  id        String   @id @default(uuid())
  action    LogAction
  details   String   // "Admin changed score of Team A from 50 to 100"
  ip_address String?

  timestamp DateTime @default(now())

  user_id   String?
  user      User?    @relation(fields: [user_id], references: [id])
}
